name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (for example 1.2.3 or 1.2.3rc1)"
        required: true
        type: string
      prerelease:
        description: "Mark release as pre-release"
        required: true
        default: true
        type: boolean
      sign_artifacts:
        description: "Sign artifacts with GPG (requires release signing secrets)"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      RELEASE_VERSION: ${{ inputs.version }}
      RELEASE_PRERELEASE: ${{ inputs.prerelease }}
      RELEASE_SIGN_ARTIFACTS: ${{ inputs.sign_artifacts }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install build twine

      - name: Normalize release version
        run: |
          norm="${RELEASE_VERSION}"
          case "${norm}" in
            v*|V*) norm="${norm#?}" ;;
          esac
          if [ -z "${norm}" ]; then
            echo "Version input cannot be empty."
            exit 1
          fi
          echo "RELEASE_VERSION_NORM=${norm}" >> "${GITHUB_ENV}"

      - name: Validate release tag does not already exist
        run: |
          if git rev-parse "v${RELEASE_VERSION_NORM}" >/dev/null 2>&1; then
            echo "Tag v${RELEASE_VERSION_NORM} already exists."
            exit 1
          fi

      - name: Prepare version and changelog
        run: |
          python tools/release_prepare.py \
            --version "${RELEASE_VERSION_NORM}" \
            --notes-file RELEASE_NOTES.md

      - name: Lint
        run: |
          python -m ruff check .
          python -m ruff format --check .

      - name: Typecheck
        run: python -m mypy src

      - name: Tests
        run: python -m pytest

      - name: Build artifacts
        run: |
          python -m build
          python -m twine check dist/*

      - name: Release artifact guardrail
        run: |
          if python -m zipfile -l dist/*.whl | rg -i "libvlc\.so|libvlc\.dylib|vlc\.dll|ffmpeg|avcodec|avformat|avutil|swresample|swscale"; then
            echo "Release policy violation: found bundled media/runtime binaries in wheel."
            exit 1
          fi
          if tar -tf dist/*.tar.gz | rg -i "libvlc\.so|libvlc\.dylib|vlc\.dll|ffmpeg|avcodec|avformat|avutil|swresample|swscale"; then
            echo "Release policy violation: found bundled media/runtime binaries in sdist."
            exit 1
          fi

      - name: Generate checksums
        run: |
          sha256sum dist/* > dist/SHA256SUMS

      - name: Import signing key
        if: env.RELEASE_SIGN_ARTIFACTS == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.RELEASE_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          if [ -z "${GPG_PRIVATE_KEY}" ] || [ -z "${GPG_PASSPHRASE}" ]; then
            echo "Missing required secrets: RELEASE_GPG_PRIVATE_KEY / RELEASE_GPG_PASSPHRASE."
            exit 1
          fi
          echo "${GPG_PRIVATE_KEY}" | base64 --decode | gpg --batch --import

      - name: Sign artifacts
        if: env.RELEASE_SIGN_ARTIFACTS == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          for file in dist/*; do
            gpg \
              --batch \
              --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --armor \
              --detach-sign "${file}"
          done

      - name: Commit release files and create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/tz_player/version.py CHANGELOG.md
          git commit -m "release: v${RELEASE_VERSION_NORM}"
          git tag "v${RELEASE_VERSION_NORM}"
          git push origin HEAD:main
          git push origin "v${RELEASE_VERSION_NORM}"

      - name: Publish GitHub release
        run: |
          prerelease_flag=""
          if [ "${RELEASE_PRERELEASE}" = "true" ]; then
            prerelease_flag="--prerelease"
          fi
          gh release create "v${RELEASE_VERSION_NORM}" \
            --title "v${RELEASE_VERSION_NORM}" \
            --notes-file RELEASE_NOTES.md \
            ${prerelease_flag} \
            dist/*
