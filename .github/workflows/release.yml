name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Existing release version/tag (for example 1.2.3 or v1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Mark release as pre-release (workflow_dispatch only)"
        required: true
        default: false
        type: boolean
      sign_artifacts:
        description: "Sign artifacts with GPG (requires release signing secrets)"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_SIGN_ARTIFACTS: ${{ inputs.sign_artifacts }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install build twine

      - name: Resolve release tag/version
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
            raw="${GITHUB_REF_NAME}"
          else
            raw="${{ inputs.version }}"
          fi
          norm="${raw}"
          case "${norm}" in
            v*|V*) norm="${norm#?}" ;;
          esac
          if [ -z "${norm}" ]; then
            echo "Version input cannot be empty."
            exit 1
          fi
          echo "RELEASE_VERSION_NORM=${norm}" >> "${GITHUB_ENV}"
          echo "RELEASE_TAG=v${norm}" >> "${GITHUB_ENV}"

      - name: Set prerelease mode
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "RELEASE_PRERELEASE=${{ inputs.prerelease }}" >> "${GITHUB_ENV}"
          elif [[ "${RELEASE_VERSION_NORM}" =~ (a|b|rc|dev|post) ]]; then
            echo "RELEASE_PRERELEASE=true" >> "${GITHUB_ENV}"
          else
            echo "RELEASE_PRERELEASE=false" >> "${GITHUB_ENV}"
          fi

      - name: Ensure release tag exists and checkout
        run: |
          if ! git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Tag ${RELEASE_TAG} not found."
            echo "Create and push the tag first, then run this workflow."
            exit 1
          fi
          git checkout "${RELEASE_TAG}"

      - name: Build release notes from changelog
        run: |
          python tools/extract_changelog_release.py \
            --version "${RELEASE_VERSION_NORM}" \
            --changelog CHANGELOG.md \
            --output RELEASE_NOTES.md

      - name: Lint
        run: |
          python -m ruff check .
          python -m ruff format --check .

      - name: Typecheck
        run: python -m mypy src

      - name: Tests
        run: python -m pytest

      - name: Build artifacts
        run: |
          python -m build
          python -m twine check dist/*

      - name: Release artifact guardrail
        run: |
          if python -m zipfile -l dist/*.whl | rg -i "libvlc\.so|libvlc\.dylib|vlc\.dll|ffmpeg|avcodec|avformat|avutil|swresample|swscale"; then
            echo "Release policy violation: found bundled media/runtime binaries in wheel."
            exit 1
          fi
          if tar -tf dist/*.tar.gz | rg -i "libvlc\.so|libvlc\.dylib|vlc\.dll|ffmpeg|avcodec|avformat|avutil|swresample|swscale"; then
            echo "Release policy violation: found bundled media/runtime binaries in sdist."
            exit 1
          fi

      - name: Generate checksums
        run: |
          sha256sum dist/* > dist/SHA256SUMS

      - name: Import signing key
        if: env.RELEASE_SIGN_ARTIFACTS == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.RELEASE_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          if [ -z "${GPG_PRIVATE_KEY}" ] || [ -z "${GPG_PASSPHRASE}" ]; then
            echo "Missing required secrets: RELEASE_GPG_PRIVATE_KEY / RELEASE_GPG_PASSPHRASE."
            exit 1
          fi
          echo "${GPG_PRIVATE_KEY}" | base64 --decode | gpg --batch --import

      - name: Sign artifacts
        if: env.RELEASE_SIGN_ARTIFACTS == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          for file in dist/*; do
            gpg \
              --batch \
              --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --armor \
              --detach-sign "${file}"
          done

      - name: Publish or update GitHub release
        run: |
          prerelease_flag=""
          if [ "${RELEASE_PRERELEASE}" = "true" ]; then
            prerelease_flag="--prerelease"
          fi
          if gh release view "${RELEASE_TAG}" >/dev/null 2>&1; then
            gh release upload "${RELEASE_TAG}" dist/* --clobber
          else
            gh release create "${RELEASE_TAG}" \
              --title "${RELEASE_TAG}" \
              --notes-file RELEASE_NOTES.md \
              ${prerelease_flag} \
              dist/*
          fi
